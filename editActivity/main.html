<!DOCTYPE html>
<html>
<head>
<title>Home</title>
<link href="../css/bootstrap.css" rel="stylesheet" type="text/css" media="all" />
<script src="../js/jquery.min.js"></script>
<script src="../js/popup.js"></script>
<link href="../css/style.css" rel="stylesheet" type="text/css" media="all" />
<link href="../css/popup.css" rel="stylesheet" type="text/css" media="all" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
</head>
<body onload="init();">

<!--login and register-->
<div class="header container">
    <div class="logo">
        <a href="../index.html"><img src="../images/logo.png" alt="click this to homepage" /></a>
    </div>
    <div class="top-nav">
        <nav class="main_nav">
            <ul>
            <li><a href="#0" class="scroll">登录</a></li>
            <li><a href="#0" class="scroll">注册</a></li>
        </ul>
        </nav>
    </div>


    <div class="cd-user-modal">
        <div class="cd-user-modal-container">
            <ul class="cd-switcher">
                <li><a href="#0">用户登录</a></li>
                <li><a href="#0">注册新用户</a></li>
            </ul>
            <!-- 登录表单 -->
            <div id="cd-login"> 
                <form class="cd-form">
                    <p class="fieldset">
                        <label class="image-replace cd-username" for="signin-username">用户名</label>
                        <input class="full-width has-padding has-border" id="signin-username" type="text" placeholder="输入用户名">
                    </p>

                    <p class="fieldset">
                        <label class="image-replace cd-password" for="signin-password">密码</label>
                        <input class="full-width has-padding has-border" id="signin-password" type="text"  placeholder="输入密码">
                    </p>

                    <p class="fieldset">
                        <input type="checkbox" id="remember-me" checked>
                        <label for="remember-me">记住登录状态</label>
                    </p>

                    <p class="fieldset">
                        <input class="full-width2" type="submit" value="登 录">
                    </p>
                </form>
            </div>
            <!-- 注册表单 -->
            <div id="cd-signup"> 
                <form class="cd-form">
                    <p class="fieldset">
                        <label class="image-replace cd-username" for="signup-username">用户名</label>
                        <input class="full-width has-padding has-border" id="signup-username" type="text" placeholder="输入用户名">
                    </p>

                    <p class="fieldset">
                        <label class="image-replace cd-email" for="signup-email">邮箱</label>
                        <input class="full-width has-padding has-border" id="signup-email" type="email" placeholder="输入mail">
                    </p>

                    <p class="fieldset">
                        <label class="image-replace cd-password" for="signup-password">密码</label>
                        <input class="full-width has-padding has-border" id="signup-password" type="text"  placeholder="输入密码">
                    </p>

                    <p class="fieldset">
                        <input type="checkbox" id="accept-terms">
                        <label for="accept-terms">我已阅读并同意 <a href="#0">用户协议</a></label>
                    </p>

                    <p class="fieldset">
                        <input class="full-width2" type="submit" value="注册新用户">
                    </p>
                </form>
            </div>

            <a href="#0" class="cd-close-form">关闭</a>
        </div>
    </div>
</div>
<!---->

<!-- styles for the page -->
<style>
.title_row h1{
    /* padding: 1em 0 0 2em; */
    font-size: 3em;
    /* line-height: 1em; */
    font-weight:bold;
    text-align: center;
}

.with_side_border{
    padding-left:2em; 
    padding-right:2em; 
    border-right: 0.5em solid #ccc;
    border-left: 0.5em solid #ccc;
}

textarea {
    border: 0 none white;
    overflow: hidden;
    outline: none;
    background-color: #D0D0D0;
    /* width: 100%; */
    text-indent: 2em;
    padding: 0 0 0.5em 0;
    font-size: 1.3em; 
    line-height: 150%
}

.project_page_main_story
.project_page_main_story h1{
    padding: 0 0 0.2em 0;
    width: 100%;
    font-size: 1.7em; 
    font-weight:600; 
}
.project_page_main_story p{
    text-indent: 2em;
    padding: 0 0 0.5em 0;
    width: 100%;
    font-size: 1.3em; 
    line-height: 150%
}
.project_page_main_story img{
    padding: 1em 0 1em 0;
    width: 100%
}

/* 右击菜单 */
.menu
{
    width: 150px;
    box-shadow: 3px 3px 5px #888888;
    border-style: solid;
    border-width: 1px;
    border-color: grey;
    border-radius: 2px;
    padding-left: 5px;
    padding-right: 5px;
    padding-top: 3px;
    padding-bottom: 3px;
    position: fixed;
    display: none;
    background-color: white;
    font-size: 1.3em; 
}

.menu-item
{
    padding-top: 0.35em;
    height: 2em;
}

.menu-item:hover
{
    background-color: #6CB5FF;
    cursor: pointer;
}
</style>

<!-- 实现了输入框自动调整尺寸适应内容，在输入框末尾敲击回车保存这一行数据，点击已经发布的行可以编辑。实现的关键是移动名为textInput的textarea控件 -->
<!-- 未实现功能：图片 -->
<!-- 存在bug：行号异常+1 -->
<!-- 覆盖右击菜单 http://qnimate.com/customizing-right-click-in-html-page/ -->
<!-- 点击按钮后选择图片并替换 https://stackoverflow.com/questions/17138244/how-to-display-selected-image-without-sending-data-to-server -->
<script>
    var observe;
    var editingLineId;
    var editingLineTagName;
    var totalLineNum;
    var idCount;
    var menuDisplayed = false;
    var menuBox = null;
    if (window.attachEvent) {
        observe = function (element, event, handler) {
            element.attachEvent('on'+event, handler);
        };
    }
    else {
        observe = function (element, event, handler) {
            element.addEventListener(event, handler, false);
        };

    // -------页面初始化，动态添加元素
    function init () {
        idCount=0;
        // "" if inserting a new line, otherwise the id of the line being edited (temporarily removed)
        editingLineId="";
        editingLineType="";

        var textInput = document.getElementById('textInput');
        observe(textInput, 'change',  resize);
        observe(textInput, 'cut',     delayedResize);
        observe(textInput, 'paste',   delayedResize);
        observe(textInput, 'drop',    delayedResize);
        observe(textInput, 'keydown', delayedResize);
        observe(window, 'click', hideContextmenuIfDisplayed);
        observe(textInput, 'click', hideContextmenuIfDisplayed);
        textInput.focus();
        textInput.select();
        listenToRightClickOnLine(textInput);

        var textInput = document.getElementById('titleInput');
        textInput.value="项目标题";
        var textInput = document.getElementById('opganizerInput');
        textInput.value="运营机构";

        insertNewElement(buildNewTextLine("2017年9月1日，极重度听力障碍的康康成为了一名一年级的新生，康康妈妈像所有的学生家长一样，开始每天检查康康作业督促他学习；跟其他妈妈不一样是，她要不时开导康康：耳蜗就像眼镜，不能摘，摘了就听不到了。因为康康现在就读于普通小学，他非常渴望和同学们一样不用带他的“小耳朵”去上学。"));
        insertNewElement(buildNewTextLine("康康家有6口人，爸爸妈妈在城里打工赚钱，他和爷爷奶奶还有失明的太奶奶生活在农村的家中，虽然家庭并不富裕甚至由于老人多并且身体也不太好，这个家还有些清贫，但在乡间的生活是简单而快乐的，直到2014年底，原来还能说些话的康康不能再开口说话，妈妈带他到长沙的医院，才发现康康是极重度感音神经性耳聋，这个时候康康已经4岁了，如果不能及时植入人工耳蜗，康康可能会失去最佳康复期。"));
        insertNewElement(buildNewTextLine("【爱的分贝简介】","h1"));
        insertNewElement(buildNewImgLine("images/story0.jpg"))
        insertNewElement(buildNewTextLine("爱的分贝，成立于2012年3月2日，由众多播音员主持人共同发起的一项针对贫困聋儿进行救助的公益项目，隶属于中华思源工程扶贫基金会。"));
        insertNewElement(buildNewTextLine("爱的分贝旨在通过人工耳蜗手术植入资助、听力语言康复资助、听障儿童家长培训、中小康复机构能力建设、爱耳知识宣传等多样化的形式，从资金支持、政策咨询、就医指导、康复教育师资培训、机构教辅教具提供等多个方面为听障儿童群体提供支持和帮助。"));
        insertNewElement(buildNewTextLine("五年时间，通过线上月捐平台等捐赠渠道已有160余万爱心捐赠人，爱的分贝累计为10000多个听障儿童家庭提供了救助服务，并直接资助近2500多个贫困听障儿童家庭，让400位听障儿童接受了人工耳蜗植入手术，对超过1000位听障儿童进行了康复训练，培训了1100多位听障儿童家长。"));

        resize();
    }


    // -------自适应缩放textarea，顺便检查是否有回车(新起一段)
    function resize () {
        // do when we catch an "enter"
        textInput=document.getElementById('textInput');
        while(textInput.value.length>0){
            var splitPos = textInput.value.search('\n');
            // alert("Substring position: "+splitPos.toString());
            if(splitPos<0){
                break;
            }
            else if((textInput.value.length == 1) && (textInput.value[0] == '\n')){
                textInput.value="";
            }
            else{
                var newTextLineContent = textInput.value.substring(0,splitPos);
                insertNewElement(buildNewTextLine(newTextLineContent, editingLineTagName, editingLineId),"textInput")
                editingLineTagName="";
                editingLineId="";
                textInput.value = textInput.value.substring(splitPos+1, textInput.value.length-1);
                // alert("分割长度: "+newParagraphContent.length.toString()+", 剩余长度: "+textInput.value.length.toString());
            }
        }
        textInput.style.height = 'auto';
        textInput.style.height = textInput.scrollHeight+'px';
    }
    /* 0-timeout to get the already changed text */
    function delayedResize () {
        window.setTimeout(resize, 0);
    }
    // -------


    // -------构建新段落元素
    function buildNewTextLine(contentIn,lineTagName="P",editingIDIn=""){
        if(contentIn=="")
            return null;
        var newElement=null;
        if(lineTagName.toLowerCase() == 'p' || lineTagName == ""){
            newElement = document.createElement("p");
        }
        else if(lineTagName.toLowerCase() == 'h1'){
            newElement = document.createElement("h1");
        }
        var node = document.createTextNode(contentIn);
        if(editingIDIn==""){
            newElement.setAttribute("id", "contentLine"+idCount.toString());
            idCount+=1;
        }
        else{
            newElement.setAttribute("id", editingIDIn);
        }
        newElement.appendChild(node);
        listenToLeftClickOnLine(newElement);
        listenToRightClickOnLine(newElement);
        return newElement;
    }   
    // -------构建新图片元素
    function buildNewImgLine(imgUrl){
        if(imgUrl=="")
            return null;
            
        var newElement = document.createElement("img");
        newElement.src = imgUrl;
        newElement.setAttribute("id", "contentLine"+idCount.toString()+newElement.className);
        idCount+=1;

        listenToRightClickOnLine(newElement);
        return newElement;
    }


    // -------插入新元素在制定元素之前或默认在textInput之后
    function insertNewElement(newElement,afterID="textInput"){
        if(newElement!==null){
            var editor = document.getElementById("project_edit_page_editor");
            var textInput = document.getElementById(afterID);
            editor.insertBefore(newElement,textInput);
            if(newElement.tagName == "P"){
                editingLineId="";
            }
        }
    }


    // -------左键点击时，编辑已有段落
    function editLine(moveInputTolineId){
        var textInput = document.getElementById('textInput');
        var moveInputToLine = document.getElementById(moveInputTolineId);
        var editor = document.getElementById("project_edit_page_editor");
        if(editingLineId!==""){
            newLine = buildNewTextLine(textInput.value,editingLineTagName,editingLineId)
            if(newLine!==null){
                // listenToLeftClickOnLine(newLine);
                editor.insertBefore(newLine,textInput);
            }
            editingLineId = "";
            editingLineTagName = "";
        }
        editor.insertBefore(textInput,moveInputToLine);
        textInput.value=moveInputToLine.innerHTML;
        editingLineId=moveInputTolineId;
        editor.removeChild(moveInputToLine);
        resize();
    }

    // -------响应右击，弹出菜单
    function activateImgContextMenu(arguments,clickedElementID){
        var left = arguments[0].clientX;
        var top = arguments[0].clientY;

        menuBox = window.document.querySelector(".menu");
        menuBox.style.left = left + "px";
        menuBox.style.top = top + "px";
        menuBox.style.display = "block";

        var clickedElement = document.getElementById(clickedElementID);
        var RightClickMenuInsertAbove = document.getElementById("RightClickMenuInsertAbove");
        var RightClickMenuDelete = document.getElementById("RightClickMenuDelete");
        var RightClickMenuReplace = document.getElementById("RightClickMenuReplace");
        var RightClickMenuChangeTextTagName = document.getElementById("RightClickMenuChangeTextTagName");
        var RightClickMenuDebug = document.getElementById("RightClickMenuDebug");

        RightClickMenuInsertAbove.hidden = false;
        listenToClickToInsertImage(RightClickMenuInsertAbove, clickedElementID);
        if(clickedElement.tagName.toLowerCase() == "p"){
            // 点击文字段
            RightClickMenuDelete.hidden = false;
            RightClickMenuDelete.innerHTML = "删除本段";

            RightClickMenuReplace.hidden = true;

            RightClickMenuChangeTextTagName.hidden = false;

            RightClickMenuChangeTextTagName.innerHTML = "设为段落标题";
            RightClickMenuChangeTextTagName.hidden = false;
            listenToClickToChangeTextTagName(RightClickMenuChangeTextTagName,clickedElementID,"h1");
        }
        else if(clickedElement.tagName.toLowerCase() == "h1"){
            // 点击文字段
            RightClickMenuDelete.hidden = false;
            RightClickMenuDelete.innerHTML = "删除本段";

            RightClickMenuReplace.hidden = true;

            RightClickMenuChangeTextTagName.hidden = false;

            RightClickMenuChangeTextTagName.innerHTML = "设为正文";
            RightClickMenuChangeTextTagName.hidden = false;
            listenToClickToChangeTextTagName(RightClickMenuChangeTextTagName,clickedElementID,"P");
        }
        else if(clickedElement.tagName.toLowerCase() == "img"){
            // 点击图片
            RightClickMenuDelete.hidden = false;
            RightClickMenuDelete.innerHTML = "删除插图";

            RightClickMenuReplace.hidden = false;
            RightClickMenuReplace.innerHTML = "替换插图";
            listenToClickToReplace(RightClickMenuReplace, clickedElementID)

            RightClickMenuChangeTextTagName.hidden = true;
      }
       else if(clickedElement.tagName.toLowerCase() == "textarea"){
           // 点击编辑中文字
           RightClickMenuDelete.hidden = true;
           RightClickMenuReplace.hidden = true;
           RightClickMenuChangeTextTagName.hidden = true;
      }
        RightClickMenuDebug.innerHTML=clickedElement.tagName;
        listenToClickToDelete(RightClickMenuDelete,clickedElementID);

        menuDisplayed = true;
        // alert("");
        arguments[0].preventDefault();
    }

    function hideContextmenuIfDisplayed(){
        if(menuDisplayed == true){
            menuBox.style.display = "none"; 
            menuDisplayed = false;
        }
    }


    // -------
    // -------添加页面点击响应
    function listenToLeftClickOnLine(lineToListen){
        var idCp = lineToListen.getAttribute("id");
        observe(lineToListen, 'click',function(){hideContextmenuIfDisplayed();editLine(idCp);});
    }
    function listenToRightClickOnLine(lineToListen){
        var idCp = lineToListen.getAttribute("id");
        observe(lineToListen, 'contextmenu',function(){hideContextmenuIfDisplayed();activateImgContextMenu(arguments,idCp);});
    }
    // -------


    // -------添加右击菜单响应
    // 添加右击菜单选项-在上方插入图片的动作响应
    function listenToClickToInsertImage(elementToClick, elementAfterTheImgID){
        elementToClickWithoutListeners = removeCurrentListeners(elementToClick);
        observe(elementToClickWithoutListeners, 'click',function(){
            hideContextmenuIfDisplayed();
            insertImageBefore(arguments,elementAfterTheImgID);});
    }
    // 添加右击菜单选项-删除本段文字/本副图片的动作响应
    function listenToClickToDelete(elementToClick, elementToDeleteID){
        elementToClickWithoutListeners = removeCurrentListeners(elementToClick);
        observe(elementToClickWithoutListeners, 'click',function(){
            hideContextmenuIfDisplayed();
            deleteElement(arguments,elementToDeleteID);});
    }
    // 添加右击菜单选项-替换本张图片的动作响应
    function listenToClickToReplace(elementToClick, elementToReplaceID){
        elementToClickWithoutListeners = removeCurrentListeners(elementToClick);
        observe(elementToClickWithoutListeners, 'click',function(){
            hideContextmenuIfDisplayed();
            replaceImage(arguments,elementToReplaceID);});
    }
    function listenToClickToSetSectionTitle(elementToClick, elementToSetAsSectionTitleID){
        elementToClickWithoutListeners = removeCurrentListeners(elementToClick);
        observe(elementToClickWithoutListeners, 'click',function(){
            hideContextmenuIfDisplayed();
            setAsSectionTitle(arguments,elementToSetAsSectionTitleID);});
    }
    function listenToClickToChangeTextTagName(elementToClick, elementToChangeTextTagName, newTagName){
        elementToClickWithoutListeners = removeCurrentListeners(elementToClick);
        observe(elementToClickWithoutListeners, 'click',function(){
            hideContextmenuIfDisplayed();
            changeTextTagName(arguments, elementToChangeTextTagName, newTagName);});
    }
    // -------


    // -------右击菜单响应后的动作
    // 在上方插入图片
    function insertImageBefore(arguments, elementAfterTheImgID){
        var imgLoader = document.getElementById("imageLoader");
        imgLoaderWithoutListeners = removeCurrentListeners(imgLoader);

        var fileReader=new FileReader();
        fileReader.onload = function(e) { 
            insertNewElement(buildNewImgLine(this.result),elementAfterTheImgID);
        };
        imgLoaderWithoutListeners.addEventListener("change",function() {
            // fill fr with image data    
            fileReader.readAsDataURL(imgLoaderWithoutListeners.files[0]);
        });
        imgLoaderWithoutListeners.click();
    }
    // 删除本段文字/本副图片的动作
    function deleteElement(arguments,elementToDeleteID){
        var editor = document.getElementById("project_edit_page_editor");
        var elementToDelete = document.getElementById(elementToDeleteID);
        editor.removeChild(elementToDelete);
    }
    // 替换图片的动作：调出文件选择工具，让用户选择一张图片，替换原图片的src
    // https://stackoverflow.com/questions/17138244/how-to-display-selected-image-without-sending-data-to-server
    function replaceImage(arguments, imgToReplaceID){
        // by replacing the element with its clone, all the attached listeners are removed (to avoid adding a removing listener each time we click)
        var imgLoader = document.getElementById("imageLoader");
        imgLoaderWithoutListeners = removeCurrentListeners(imgLoader);

        var imgToReplace = document.getElementById(imgToReplaceID);
        var fileReader=new FileReader();
        // when image is loaded, set the src of the image where you want to display it
        fileReader.onload = function(e) { imgToReplace.src = this.result; };
        imgLoaderWithoutListeners.addEventListener("change",function() {
            // fill fr with image data    
            fileReader.readAsDataURL(imgLoaderWithoutListeners.files[0]);
        });
        imgLoaderWithoutListeners.click();
    }
    // 切换文字的标题等级或正文的动作
    function changeTextTagName(arguments, textToChangeTagNameID,newTagName){
        var textToChangeTagName = document.getElementById(textToChangeTagNameID);
        var editor = document.getElementById("project_edit_page_editor");

        textLineTagNameChanged = buildNewTextLine(textToChangeTagName.innerHTML,newTagName,textToChangeTagNameID);
        textToChangeTagName.id = "toDelete";

        editor.insertBefore(textLineTagNameChanged,textToChangeTagName);
        editor.removeChild(textToChangeTagName);
    }

    // -------辅助方法
    function removeCurrentListeners(elementToProcess){
        // by replacing the element with its clone, all the attached listeners are removed (to avoid adding a removing listener each time we click)
        var elementToProcessClone = elementToProcess.cloneNode(true);
        elementToProcess.parentNode.replaceChild(elementToProcessClone,elementToProcess);
        return elementToProcessClone;
    }
}
</script>

<!-- 本页的主体 -->

<!-- 临时空行，后面再调整 -->
<br><br><br><br><br><br>
<div class="content">
    <div class="container">
        <!-- 页面左边故事主体 -->
        <div class="col-md-9 ">
            <div class="with_side_border">
                <!-- 标题栏 -->
                <div class="row">
                    <div class="title_row">
                        <h1>项目编辑</h1>
                        <div style="text-align: center">
                            <textarea rows="1" cols="32" maxlength=32 style="height:2em; resize: none; text-align: center; text-indent: 0; width: 80%" id="titleInput"
                            onfocus="if (this.value == '项目标题') this.value=''" onblur="if (this.value == '') this.value='项目标题'">
                            </textarea>
                        </div>
                        <div style="text-align: center">
                            <textarea rows="1" cols="32" maxlength=32 style="height:2em; resize: none; text-align: center; text-indent: 0; width: 80%" id="opganizerInput"
                            onfocus="if (this.value == '运营机构') this.value=''" onblur="if (this.value == '') this.value='运营机构'">
                            </textarea>
                        </div>
                        <p></p>
                        <br>
                    </div>
                </div>
                <!-- 项目故事的主体，文字和图 -->
                <div class="row">
                    <div class="project_page_main_story" id="project_edit_page_editor">
                        <textarea rows="1" style="height:1em; resize: none; width:100%" id="textInput">
                        </textarea>
                    </div>
                </div>
            </div>
        </div>
        <!-- 暂时啥都没有 -->
        <div class="col-md-3">
            <!-- <div class="row">
                <div class="title_row">
                    <h1>&nbsp</h1>
                    <br>
                </div>
                <div class="row">
                    <div id="project_edit_page_img_selector">
                        <input type="button" value="hehe" style="position:absolute; top: 25em;">
                        <input type="button" value="haha" style="position:absolute; top: 10em;">
                    </div>
                </div>
            </div> -->
        </div>
    </div>
</div>
<br><br>
<!-- contents end -->
<!-- 右击菜单 -->
<div class="menu">
    <div class="menu-item" id="RightClickMenuInsertAbove">在上方插入图片</div>
    <div class="menu-item" id="RightClickMenuDelete">删</div>
    <div class="menu-item" id="RightClickMenuReplace">替换</div>
    <div class="menu-item" id="RightClickMenuChangeTextTagName">切换各级标题或正文</div>
    <div class="menu-item" id="RightClickMenuDebug">debug输出</div>
</div>
<!-- 隐藏的图片输入控件 -->
<input id="imageLoader" type="file" style="display:none "/>


<div class="footer">
    <div class="container">
        <ul>
            <li><a href="#" >联系我们</a></li>
            <li>|</li>
            <li><a href="#" >关于境界的彼方</a> </li>
            <li>|</li>
            <li><a href="./manage/manage_approve_program.html">管理中心</a></li>
            <li>|</li>
            <li><a href="#" >意见反馈</a> </li>
        </ul>
        <span class="drop"> </span>
        <p>境界の彼方 <span>S.E.U.</span> Suzhou, P.R.China</p>
        <p class="footer-class">Copyright &copy; 1Q84.</p>
        <ul class="social-icons">
            <li class="twitter"><a href="#"><span> </span></a></li>
            <li class="gmail"><a href="#"><span> </span></a></li>
            <li class="print"><a href="#"><span> </span></a></li>
        </ul>
    </div>
</div>

</body>
</html>
